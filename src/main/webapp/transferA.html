<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank A - Para GÃ¶nder</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
<div class="container bank-page">
    <h1 class="main-title" onclick="window.location.href='index.html'">Interbank Payment Service</h1>

    <div class="bank-header">
        <h2>Bank A - Para GÃ¶nder</h2>
        <button class="btn-back" onclick="window.location.href='bankA.html'">Geri</button>
    </div>

    <div class="bank-content-box bank-a-box">
        <div class="user-info">
            <p id="user-name"></p>
            <p id="user-email"></p>
            <p id="user-balance"></p>
        </div>

        <div class="transaction-form">
            <h3>ğŸ”„ Para GÃ¶nderme Ä°ÅŸlemi</h3>
            <form onsubmit="return handleTransfer(event)">
                <div class="form-group">
                    <label for="receiverName">AlÄ±cÄ± AdÄ±</label>
                    <input type="text" id="receiverName" name="receiverName" required 
                           placeholder="AlÄ±cÄ±nÄ±n tam adÄ±nÄ± girin">
                </div>

                <div class="form-group">
                    <label for="receiverBank">AlÄ±cÄ± BankasÄ±</label>
                    <select id="receiverBank" name="receiverBank" required>
                        <option value="">Banka SeÃ§in</option>
                        <option value="A">Bank A</option>
                        <option value="B">Bank B</option>
                        <option value="C">Bank C</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="amount">GÃ¶nderilecek Miktar (TL)</label>
                    <input type="number" id="amount" name="amount" required 
                           placeholder="Ã–rn: 250" min="1" step="0.01">
                </div>

                <div class="form-group">
                    <label for="description">AÃ§Ä±klama (Ä°steÄŸe BaÄŸlÄ±)</label>
                    <textarea id="description" name="description" rows="3" 
                              placeholder="Ä°ÅŸlem aÃ§Ä±klamasÄ±..."></textarea>
                </div>

                <div id="message" class="message" style="display: none;"></div>

                <button type="submit" class="btn-submit btn-bank-a">GÃ¶nder</button>
                <button type="button" class="btn-cancel" onclick="window.location.href='bankA.html'">Ä°ptal</button>
            </form>
        </div>
    </div>
</div>

<script src="scripts/login.js"></script>
<script>
    // Sayfa yÃ¼klendiÄŸinde kullanÄ±cÄ± bilgilerini gÃ¶ster
    window.onload = function() {
        const isLoggedIn = sessionStorage.getItem('bankA_logged_in') === 'true';
        
        if (!isLoggedIn) {
            alert('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
            window.location.href = 'bankA.html';
            return;
        }

        const userRaw = sessionStorage.getItem('bankA_user');
        if (userRaw) {
            try {
                const user = JSON.parse(userRaw);
                document.getElementById('user-name').textContent = 'Ä°sim: ' + (user.name || '');
                document.getElementById('user-email').textContent = 'Email: ' + (user.email || '');
                document.getElementById('user-balance').textContent = 'Mevcut Bakiye: ' + 
                    (typeof user.balance === 'number' ? user.balance.toFixed(2) : '0.00') + ' TL';
            } catch (e) {
                console.error('KullanÄ±cÄ± bilgisi okunamadÄ±', e);
            }
        }
    };

    function handleTransfer(event) {
        event.preventDefault();
        
        const receiverName = document.getElementById('receiverName').value;
        const receiverBank = document.getElementById('receiverBank').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const description = document.getElementById('description').value;
        const user = JSON.parse(sessionStorage.getItem('bankA_user'));

        if (!receiverName || !receiverBank || !amount || amount <= 0) {
            showMessage('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!', 'error');
            return false;
        }

        if (amount > user.balance) {
            showMessage('âŒ Yetersiz bakiye! Mevcut bakiye: ' + user.balance.toFixed(2) + ' TL', 'error');
            return false;
        }

        // Backend'e application/x-www-form-urlencoded isteÄŸi gÃ¶nder
        const params = new URLSearchParams();
        params.append('type', 'transfer');
        params.append('userEmail', user.email);
        params.append('amount', String(amount));
        params.append('description', description);
        params.append('bankName', 'Bank A');
        params.append('receiverName', receiverName);
        params.append('receiverBank', receiverBank);

        fetch('/transaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            },
            body: params.toString()
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Bakiyeyi gÃ¼ncelle
                user.balance = parseFloat(user.balance) - amount;
                sessionStorage.setItem('bankA_user', JSON.stringify(user));

                showMessage(`âœ“ ${receiverName} (Bank ${receiverBank}) kiÅŸisine ${amount.toFixed(2)} TL baÅŸarÄ±yla gÃ¶nderildi!`, 'success');

                setTimeout(() => {
                    window.location.href = 'bankA.html';
                }, 2000);
            } else {
                showMessage('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('âŒ BaÄŸlantÄ± hatasÄ±!', 'error');
        });

        return false;
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = 'message ' + type;
        messageDiv.style.display = 'block';
    }
</script>
</body>
</html>
